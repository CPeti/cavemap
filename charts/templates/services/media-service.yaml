apiVersion: apps/v1
kind: Deployment
metadata:
  name: media-service
  namespace: {{ .Values.namespace }}
{{- $registry := .Values.image.registry | default "" }}
{{- $globalTag := .Values.image.tag | default "latest" }}
{{- $svcRepo := .Values.mediaService.repository | default "media-service" }}
{{- $svcTag := default $globalTag .Values.mediaService.tag }}
{{- $svcImage := .Values.mediaService.image | default "" }}
{{- $image := ternary $svcImage (printf "%s/%s:%s" $registry $svcRepo $svcTag) (ne $svcImage "") }}
spec:
  replicas: {{ .Values.mediaService.replicas }}
  selector:
    matchLabels:
      app: media-service
  template:
    metadata:
      labels:
        app: media-service
    spec:
      imagePullSecrets:
        - name: {{ .Values.imagePullSecret.name }}
      initContainers:
        # Wait for DB to be ready
        - name: wait-for-db
          image: postgres:16
          command:
            - sh
            - -c
            - |
              until pg_isready -h {{ .Values.db.name }}-rw.{{ .Values.namespace }}.svc.cluster.local -p 5432; do
                echo "Waiting for database..."
                sleep 2
              done

        # Run Alembic migrations
        - name: run-migrations
          image: {{ $image }}
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command:
            - sh
            - -c
            - |
              echo "Running Alembic migrations..."
              alembic -c /app/alembic.ini upgrade head
          env:
            - name: DB_URL_SYNC
              value: postgresql+psycopg://{{ .Values.db.user }}:{{ .Values.db.password }}@{{ .Values.db.name }}-rw.{{ .Values.namespace }}.svc.cluster.local:5432/{{ .Values.db.database }}
      containers:
        - name: media-service
          image: {{ $image }}
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - containerPort: {{ .Values.mediaService.containerPort }}
          env:
            - name: DB_URL
              value: "postgresql+asyncpg://{{ .Values.db.user }}:{{ .Values.db.password }}@{{ .Values.db.name }}-rw:5432/{{ .Values.db.database }}"
            - name: DB_URL_SYNC
              value: "postgresql+psycopg://{{ .Values.db.user }}:{{ .Values.db.password }}@{{ .Values.db.name }}-rw:5432/{{ .Values.db.database }}"
            - name: SERVICE_TOKEN
              valueFrom:
                secretKeyRef:
                  name: service-secret
                  key: service-token
            - name: AZURE_STORAGE_ACCOUNT_NAME
              valueFrom:
                secretKeyRef:
                  name: azure-storage-secret
                  key: account-name
            - name: AZURE_STORAGE_ACCOUNT_KEY
              valueFrom:
                secretKeyRef:
                  name: azure-storage-secret
                  key: account-key
            - name: AZURE_STORAGE_CONTAINER_NAME
              value: {{ .Values.mediaService.containerName }}
            - name: OAUTH2_PROXY_AUTH_URL
              valueFrom:
                configMapKeyRef:
                  name: service-urls
                  key: OAUTH2_PROXY_AUTH_URL
            - name: RABBITMQ_URL
              valueFrom:
                configMapKeyRef:
                  name: service-urls
                  key: RABBITMQ_URL
            - name: CAVE_SERVICE_URL
              valueFrom:
                configMapKeyRef:
                  name: service-urls
                  key: CAVE_SERVICE_URL
            - name: GROUP_SERVICE_URL
              valueFrom:
                configMapKeyRef:
                  name: service-urls
                  key: GROUP_SERVICE_URL
---
apiVersion: v1
kind: Service
metadata:
  name: media-service
  namespace: {{ .Values.namespace }}
spec:
  selector:
    app: media-service
  ports:
    - port: {{ .Values.mediaService.port }}
      targetPort: {{ .Values.mediaService.containerPort }}
      protocol: TCP
  type: ClusterIP
