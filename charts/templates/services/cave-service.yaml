apiVersion: apps/v1
kind: Deployment
metadata:
  name: cave-service
  namespace: {{ .Values.namespace }}
{{- $registry := .Values.image.registry | default "" }}
{{- $globalTag := .Values.image.tag | default "latest" }}
{{- $svcRepo := .Values.caveService.repository | default "cave-service" }}
{{- $svcTag := default $globalTag .Values.caveService.tag }}
{{- $svcImage := .Values.caveService.image | default "" }}
{{- $image := ternary $svcImage (printf "%s/%s:%s" $registry $svcRepo $svcTag) (ne $svcImage "") }}
spec:
  replicas: {{ .Values.caveService.replicas }}
  selector:
    matchLabels:
      app: cave-service
  template:
    metadata:
      labels:
        app: cave-service
    spec:
      imagePullSecrets:
        - name: {{ .Values.imagePullSecret.name }}
      initContainers:
        # Wait for DB to be ready
        - name: wait-for-db
          image: postgres:16
          command:
            - sh
            - -c
            - |
              until pg_isready -h {{ .Values.db.name }}-rw.{{ .Values.namespace }}.svc.cluster.local -p 5432; do
                echo "Waiting for database..."
                sleep 2
              done

        # Run Alembic migrations
        - name: run-migrations
          image: {{ $image }}
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          command:
            - sh
            - -c
            - |
              echo "Running Alembic migrations..."
              alembic -c /app/alembic.ini upgrade head
          env:
            - name: DB_URL_SYNC
              value: postgresql+psycopg://{{ .Values.db.user }}:{{ .Values.db.password }}@{{ .Values.db.name }}-rw.{{ .Values.namespace }}.svc.cluster.local:5432/{{ .Values.db.database }}
      containers:
        - name: cave-service
          image: {{ $image }}
          imagePullPolicy: {{ .Values.image.pullPolicy }}
          ports:
            - containerPort: {{ .Values.caveService.containerPort }}
          env:
            - name: DB_URL
              value: "postgresql+asyncpg://{{ .Values.db.user }}:{{ .Values.db.password }}@{{ .Values.db.name }}-rw:5432/{{ .Values.db.database }}"
            - name: DB_URL_SYNC
              value: "postgresql+psycopg://{{ .Values.db.user }}:{{ .Values.db.password }}@{{ .Values.db.name }}-rw:5432/{{ .Values.db.database }}"
            - name: SERVICE_TOKEN
              valueFrom:
                secretKeyRef:
                  name: service-secret
                  key: service-token
            - name: OAUTH2_PROXY_AUTH_URL
              valueFrom:
                configMapKeyRef:
                  name: service-urls
                  key: OAUTH2_PROXY_AUTH_URL
            - name: RABBITMQ_URL
              valueFrom:
                configMapKeyRef:
                  name: service-urls
                  key: RABBITMQ_URL
            - name: GROUP_SERVICE_URL
              valueFrom:
                configMapKeyRef:
                  name: service-urls
                  key: GROUP_SERVICE_URL
            - name: USER_SERVICE_URL
              valueFrom:
                configMapKeyRef:
                  name: service-urls
                  key: USER_SERVICE_URL
            - name: MEDIA_SERVICE_URL
              valueFrom:
                configMapKeyRef:
                  name: service-urls
                  key: MEDIA_SERVICE_URL
---
apiVersion: v1
kind: Service
metadata:
  name: cave-service
  namespace: {{ .Values.namespace }}
spec:
  selector:
    app: cave-service
  ports:
    - port: {{ .Values.caveService.port }}
      targetPort: {{ .Values.caveService.containerPort }}
      protocol: TCP
  type: ClusterIP
